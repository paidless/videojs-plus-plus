{"version":3,"file":"subtitles.es.js","sources":["../../../source/Plugin/Subtitles/SubtitleSettingMenuItem.js","../../../source/Plugin/Subtitles/Subtitles.js"],"sourcesContent":["import videojs from 'video.js';\n\nconst SettingOptionItem = videojs.getComponent('SettingOptionItem');\n\nclass SubtitleSettingMenuItem extends SettingOptionItem {\n  constructor(player, options) {\n    super(player, {\n      ...options,\n      name: 'SubtitleSettingMenuItem',\n      label: 'Subtitles',\n      icon: 'vjs-icon-subtitles',\n      entries: player.options_.subtitles || []\n    });\n\n    this.addClass('vjs-setting-subtitles');\n\n    player.on('subtitles', (_, subtitles) => {\n      let close = true;\n\n      const entries = subtitles.map((val, index) => {\n        close = !close || !val.default;\n\n        return {\n          ...val,\n          value: index\n        };\n      });\n\n      this.setEntries([\n        ...entries,\n        {\n          label: 'Close Subtitles',\n          value: -1,\n          default: close\n        }\n      ]);\n\n      this.show();\n    });\n\n    player.on('subtitlechange', (_, { index }) => {\n      if (index === -1) {\n        // close subtitles\n        index = this.entries.length - 1;\n      }\n\n      this.select(index);\n      this.update(index);\n    });\n  }\n\n  onChange(...args) {\n    super.onChange(...args);\n    this.player_.subtitles().pick(this.selected.value);\n  }\n}\n\nvideojs\n  .getComponent('SettingMenuButton')\n  .prototype.options_.entries.push('SubtitleSettingMenuItem');\n\nvideojs.registerComponent('SubtitleSettingMenuItem', SubtitleSettingMenuItem);\n\nexport default SubtitleSettingMenuItem;\n","import videojs from 'video.js';\n\nimport './SubtitleSettingMenuItem';\nimport './Subtitles.scss';\n\nclass subtitles extends videojs.getPlugin('plugin') {\n  constructor(player, options) {\n    super(player, options);\n\n    this.flag = null;\n    this.track = null;\n\n    let timeout;\n    const handleSubtitleChangeEvent = () => {\n      clearTimeout(timeout);\n\n      const subtitles = this.values();\n      const currentSubtitle = subtitles.find(t => t.mode === 'showing') || {};\n      const newFlag = currentSubtitle.label || currentSubtitle.id || -1;\n\n      // multiple `change` event will reveiced when subtitles changed ( depends on number of subtitles or browser ? )\n      // so that timeout is used to make sure `subtitlechange` event emit once;\n      timeout = setTimeout(() => {\n        if (this.flag !== newFlag) {\n          this.flag = newFlag;\n\n          player.trigger('subtitlechange', {\n            index: subtitles.indexOf(currentSubtitle),\n            label: currentSubtitle.label || ''\n          });\n        }\n      }, 10);\n    };\n\n    player.textTracks().on('change', handleSubtitleChangeEvent);\n    player.on('dispose', () => {\n      player.textTracks().off('change', handleSubtitleChangeEvent);\n    });\n  }\n\n  values() {\n    const tracks = this.player.textTracks();\n    const subtitles = [];\n\n    for (let i = 0; i < tracks.length; i++) {\n      if (tracks[i].kind === 'subtitles') {\n        subtitles.push(tracks[i]);\n      }\n    }\n\n    return subtitles;\n  }\n\n  load(subtitles_ = []) {\n    const { player } = this;\n\n    if (subtitles_ && subtitles_.length) {\n      this.remove();\n\n      let index = -1;\n      const trackEls = [];\n      const subtitles = subtitles_.map((s, i) => {\n        const subtitle = Object.assign({}, s);\n        const manualCleanup = true;\n\n        // set default to false, otherwise subtitle will reset to the default subtitle\n        // when user switch quality with quality plugin\n        const trackEl = player.addRemoteTextTrack(\n          {\n            ...subtitle,\n            default: false\n          },\n          manualCleanup\n        );\n\n        trackEl.track.mode = 'hidden';\n\n        trackEls.push(trackEl);\n\n        if (index === -1 && subtitle.default === true) {\n          index = i;\n        } else {\n          subtitle.default = false;\n        }\n\n        return subtitle;\n      });\n\n      if (index !== -1) {\n        this.flag = subtitles[index].label;\n        this.track = trackEls[index].track;\n        this.track.mode = 'showing';\n      }\n\n      player.trigger('subtitles', subtitles);\n    }\n\n    return this;\n  }\n\n  remove() {\n    this.values().forEach(track => {\n      this.player.removeRemoteTextTrack(track);\n    });\n\n    return this;\n  }\n\n  pick(index) {\n    const subtitles = this.values();\n    const newTrack = subtitles[index];\n\n    if (newTrack) {\n      if (this.track) {\n        this.track.mode = 'disabled';\n      }\n      this.track = newTrack;\n      this.track.mode = 'showing';\n    } else if (this.track) {\n      this.track.mode = 'disabled';\n    }\n\n    return this;\n  }\n}\n\nvideojs.hook('setup', vjsPlayer => {\n  vjsPlayer.ready(() => {\n    const { subtitles } = vjsPlayer.options_;\n    subtitles && subtitles.length && vjsPlayer.subtitles().load(subtitles);\n  });\n});\n\nvideojs.registerPlugin('subtitles', subtitles);\n"],"names":["SettingOptionItem","videojs","getComponent","SubtitleSettingMenuItem","player","options","name","label","icon","entries","options_","subtitles","addClass","on","_","close","map","val","index","value","setEntries","show","length","select","update","onChange","args","player_","pick","selected","prototype","push","registerComponent","flag","track","timeout","handleSubtitleChangeEvent","clearTimeout","values","currentSubtitle","find","t","mode","newFlag","id","setTimeout","trigger","indexOf","textTracks","off","tracks","i","kind","load","subtitles_","remove","trackEls","s","subtitle","Object","assign","manualCleanup","trackEl","addRemoteTextTrack","forEach","removeRemoteTextTrack","newTrack","getPlugin","hook","vjsPlayer","ready","registerPlugin"],"mappings":"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"}